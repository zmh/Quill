name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0

jobs:
  build-and-release:
    name: Build and Release macOS App
    runs-on: macos-14  # Latest macOS runner
    permissions:
      contents: write  # Required to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # Project format 77 requires Xcode 16+

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Release
        env:
          SKIP_CODESIGN: "true"  # Build unsigned for GitHub distribution
        run: |
          chmod +x Scripts/build-release.sh
          ./Scripts/build-release.sh ${{ steps.version.outputs.version }}

      - name: Create DMG
        env:
          SKIP_CODESIGN: "true"  # Skip DMG signing in CI (app bundle is already signed)
        run: |
          chmod +x Scripts/create-dmg.sh
          ./Scripts/create-dmg.sh ${{ steps.version.outputs.version }}

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            echo "## What's Changed" > release_notes.md
            echo "" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          else
            echo "Initial release" > release_notes.md
          fi

          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "1. Download \`Quill-${{ steps.version.outputs.version }}.dmg\`" >> release_notes.md
          echo "2. Open the DMG file" >> release_notes.md
          echo "3. Drag Quill to your Applications folder" >> release_notes.md
          echo "4. Launch Quill from Applications" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Verification" >> release_notes.md
          echo "" >> release_notes.md
          echo "SHA256 checksum:" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          cat build/Quill-${{ steps.version.outputs.version }}.dmg.sha256 >> release_notes.md
          echo "\`\`\`" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/Quill-${{ steps.version.outputs.version }}.dmg
            build/Quill-${{ steps.version.outputs.version }}.dmg.sha256
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Appcast
        run: |
          # Create appcast directory if it doesn't exist
          mkdir -p build/appcast

          # Generate appcast entry
          VERSION="${{ steps.version.outputs.version }}"
          DMG_SIZE=$(stat -f%z "build/Quill-${VERSION}.dmg")
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Quill-${VERSION}.dmg"

          # Note: In production, you would sign the release with EdDSA
          # For now, we create the structure without signatures
          cat > "build/appcast/appcast.xml" << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
              <channel>
                  <title>Quill Updates</title>
                  <description>Most recent updates to Quill</description>
                  <language>en</language>
                  <item>
                      <title>Version ${VERSION}</title>
                      <pubDate>${DATE}</pubDate>
                      <sparkle:version>${VERSION}</sparkle:version>
                      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                      <description><![CDATA[
                          <h2>What's New in ${VERSION}</h2>
                          <p>See the <a href="https://github.com/${{ github.repository }}/releases/tag/v${VERSION}">release notes</a> for details.</p>
                      ]]></description>
                      <enclosure
                          url="${DOWNLOAD_URL}"
                          length="${DMG_SIZE}"
                          type="application/octet-stream"
                      />
                      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                  </item>
              </channel>
          </rss>
          EOF

          echo "Appcast generated at build/appcast/appcast.xml"

      - name: Upload Appcast as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: appcast
          path: build/appcast/appcast.xml

      - name: Update Appcast in Repository
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get current branch/commit (we're in detached HEAD from tag checkout)
          CURRENT_COMMIT=$(git rev-parse HEAD)

          # Fetch and checkout main branch
          git fetch origin main
          git checkout main

          # Generate the new appcast item
          VERSION="${{ steps.version.outputs.version }}"
          DMG_SIZE=$(stat -f%z "build/Quill-${VERSION}.dmg")
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Quill-${VERSION}.dmg"

          # Get release notes from the release_notes.md (first 5 lines after "What's Changed")
          RELEASE_NOTES=$(sed -n '/## What'\''s Changed/,/## Installation/{/## What'\''s Changed/d;/## Installation/d;p;}' release_notes.md | head -5 | sed 's/^- \(.*\) ([a-f0-9]*)/                    <li>\1<\/li>/')

          # Create new item XML
          NEW_ITEM=$(cat <<EOF
        <item>
            <title>Version ${VERSION}</title>
            <pubDate>${DATE}</pubDate>
            <sparkle:version>${VERSION}</sparkle:version>
            <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
            <description><![CDATA[
                <h2>What's New in ${VERSION}</h2>
                <ul>
${RELEASE_NOTES}
                </ul>
                <p>See the <a href="https://github.com/${{ github.repository }}/releases/tag/v${VERSION}">full release notes</a> for details.</p>
            ]]></description>
            <enclosure
                url="${DOWNLOAD_URL}"
                length="${DMG_SIZE}"
                type="application/octet-stream"
            />
            <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
        </item>

EOF
)

          # Insert new item after the comment block and before the first existing item
          # Using awk to find the insertion point
          awk -v new_item="$NEW_ITEM" '
            /-->/ && !inserted {
              print;
              print "";
              print new_item;
              inserted=1;
              next
            }
            { print }
          ' appcast.xml > appcast.xml.tmp

          mv appcast.xml.tmp appcast.xml

          # Commit and push if there are changes
          if git diff --quiet appcast.xml; then
            echo "No changes to appcast.xml"
          else
            git add appcast.xml
            git commit -m "Update appcast.xml for v${VERSION}

Automatically updated by GitHub Actions release workflow.

Release: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
            git push origin main
            echo "âœ“ Appcast updated and pushed to main branch"
          fi

  notify:
    name: Notify Release Complete
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "### Release Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version ${{ needs.build-and-release.outputs.version }} has been built and released." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the release by downloading from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… appcast.xml automatically updated on main branch" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce the release to users" >> $GITHUB_STEP_SUMMARY
